<%- include('../layouts/header', { title: 'Tambah Muzakki - Zakat Fitrah App' , bodyClass: 'bg-gray-50' ,
  currentPage: 'muzakki' }) %>

  <div class="page-wrapper">
    <!-- Modern Header -->
    <div class="page-header">
      <div class="header-content-wrapper">
        <div class="header-left-section">
          <a href="/muzakki" class="back-button">
            <i class="fas fa-arrow-left"></i>
          </a>
          <div class="header-icon-box">
            <i class="fas fa-user-plus"></i>
          </div>
          <div class="header-text-box">
            <h1 class="header-title-text">Tambah Muzakki</h1>
            <p class="header-subtitle-text">Daftarkan muzakki baru dan hitung zakat fitrah</p>
          </div>
        </div>
        <div class="header-actions">
          <div class="info-badge">
            <i class="fas fa-info-circle"></i>
            <span>Form Pendaftaran</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Form Container -->
    <div class="form-container">
      <form action="/muzakki" method="POST" id="muzakkiForm">
        <!-- RT Selection Card -->
        <div class="form-card">
          <div class="card-header">
            <div class="card-header-icon">
              <i class="fas fa-map-marker-alt"></i>
            </div>
            <div class="card-header-text">
              <h2 class="card-title">Pilih RT</h2>
              <p class="card-subtitle">Tentukan RT tempat muzakki terdaftar</p>
            </div>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label for="rt_id" class="form-label">
                <i class="fas fa-home mr-1"></i>RT <span class="required">*</span>
              </label>
              <select id="rt_id" name="rt_id" required class="form-select">
                <option value="">Pilih RT</option>
                <% rtList.forEach(function(rt) { %>
                  <option value="<%= rt.id %>">
                    RT <%= rt.nomor_rt %> - <%= rt.ketua_rt %>
                  </option>
                  <% }); %>
              </select>
            </div>
          </div>
        </div>

        <!-- Data Identitas Muzakki Card -->
        <div class="form-card">
          <div class="card-header">
            <div class="card-header-icon">
              <i class="fas fa-id-card"></i>
            </div>
            <div class="card-header-text">
              <h2 class="card-title">Data Identitas Muzakki</h2>
              <p class="card-subtitle">Masukkan data lengkap muzakki yang akan didaftarkan</p>
            </div>
          </div>
          <div class="card-body">
            <!-- Container untuk semua section muzakki -->
            <div id="muzakkiContainer">
              <!-- Section Muzakki Pertama -->
              <div class="muzakki-section" data-index="0">
                <div class="muzakki-section-header">
                  <h4 class="muzakki-section-title">
                    <i class="fas fa-user-circle"></i>Muzakki #1
                  </h4>
                </div>

                <div class="form-grid">
                  <!-- Nama Muzakki -->
                  <div class="form-group form-group-full">
                    <label for="nama_0" class="form-label">
                      <i class="fas fa-user mr-1"></i>Nama Lengkap Muzakki <span class="required">*</span>
                    </label>
                    <input type="text" id="nama_0" name="muzakki[0][nama]" required class="form-input"
                      placeholder="Masukkan nama lengkap muzakki" />
                  </div>

                  <!-- Bin/Binti -->
                  <div class="form-group">
                    <label for="bin_binti_0" class="form-label">
                      <i class="fas fa-venus-mars mr-1"></i>Bin/Binti
                    </label>
                    <select id="bin_binti_0" name="muzakki[0][bin_binti]" class="form-select">
                      <option value="">Pilih</option>
                      <option value="bin">Bin (Anak Laki-laki)</option>
                      <option value="binti">Binti (Anak Perempuan)</option>
                    </select>
                    <p class="form-hint">
                      Bin untuk laki-laki, Binti untuk perempuan
                    </p>
                  </div>

                  <!-- Nama Orang Tua -->
                  <div class="form-group form-group-double">
                    <label for="nama_orang_tua_0" class="form-label">
                      <i class="fas fa-users mr-1"></i>Nama Orang Tua
                    </label>
                    <input type="text" id="nama_orang_tua_0" name="muzakki[0][nama_orang_tua]" class="form-input"
                      placeholder="Masukkan nama ayah atau ibu sesuai bin/binti" />
                    <p class="form-hint">
                      Nama ayah jika "bin", nama ibu jika "binti"
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Tombol Tambah Muzakki -->
            <button type="button" id="addMuzakkiBtn" class="btn-add-muzakki" onclick="addMuzakkiSection()">
              <i class="fas fa-plus"></i>
              <span>Tambah Muzakki</span>
            </button>
          </div>
        </div>

        <!-- Perhitungan Zakat Card -->
        <div class="form-card">
          <div class="card-header">
            <div class="card-header-icon">
              <i class="fas fa-calculator"></i>
            </div>
            <div class="card-header-text">
              <h2 class="card-title">Perhitungan Zakat</h2>
              <p class="card-subtitle">Tentukan jenis dan jumlah zakat yang dibayarkan</p>
            </div>
          </div>
          <div class="card-body">
            <div class="form-grid">
              <!-- Jumlah Jiwa -->
              <div class="form-group">
                <label for="jumlah_jiwa" class="form-label">
                  <i class="fas fa-users mr-1"></i>Jumlah Jiwa <span class="required">*</span>
                </label>
                <input type="number" id="jumlah_jiwa" name="jumlah_jiwa" required min="0"
                  class="form-input input-readonly" placeholder="0" readonly
                  title="Otomatis terisi sesuai jumlah muzakki" />
                <p class="form-hint">
                  Jumlah jiwa akan otomatis terisi sesuai jumlah muzakki yang diinput
                </p>
              </div>

              <!-- Jenis Zakat -->
              <div class="form-group">
                <label for="jenis_zakat" class="form-label">
                  <i class="fas fa-hand-holding mr-1"></i>Jenis Zakat <span class="required">*</span>
                </label>
                <select id="jenis_zakat" name="jenis_zakat" required class="form-select" onchange="calculateZakat()">
                  <option value="">Pilih jenis zakat</option>
                  <option value="beras">Beras (2.5 kg/jiwa)</option>
                  <option value="uang">Uang (Rp 45.000/jiwa)</option>
                </select>
              </div>

              <!-- Kewajiban Display -->
              <div class="form-group form-group-full">
                <div class="kewajiban-box">
                  <div class="kewajiban-icon">
                    <i class="fas fa-calculator"></i>
                  </div>
                  <div class="kewajiban-content">
                    <div class="kewajiban-label">Kewajiban Zakat</div>
                    <div class="kewajiban-value" id="kewajiban_display">-</div>
                  </div>
                </div>
              </div>

              <!-- Jumlah Bayar -->
              <div class="form-group form-group-full">
                <label for="jumlah_bayar_display" class="form-label">
                  <i class="fas fa-money-bill-wave mr-1"></i>Jumlah Bayar (Rp) <span class="required">*</span>
                </label>
                <div class="input-with-prefix">
                  <span class="input-prefix">Rp</span>
                  <input type="text" id="jumlah_bayar_display" class="form-input input-with-prefix-field"
                    placeholder="0" oninput="handleRupiahInput(this)" onblur="finalizeRupiahInput(this)"
                    onfocus="prepareRupiahInput(this)" />
                  <input type="hidden" id="jumlah_bayar" name="jumlah_bayar" required />
                </div>
                <p class="form-hint">
                  Jika lebih dari kewajiban, selisihnya akan menjadi kembalian yang bisa disedekahkan
                </p>
              </div>

              <!-- Catatan -->
              <div class="form-group form-group-full">
                <label for="catatan" class="form-label">
                  <i class="fas fa-sticky-note mr-1"></i>Catatan (Opsional)
                </label>
                <textarea id="catatan" name="catatan" rows="3" class="form-textarea"
                  placeholder="Catatan tambahan atau keterangan khusus"></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Submit Buttons -->
        <div class="form-actions">
          <a href="/muzakki" class="btn-secondary">
            <i class="fas fa-times"></i>
            <span>Batal</span>
          </a>
          <button type="submit" class="btn-primary">
            <i class="fas fa-save"></i>
            <span>Simpan Data</span>
          </button>
        </div>
      </form>
    </div>

    <!-- Helper Information -->
    <div class="info-grid">
      <div class="info-card info-card-green">
        <div class="info-card-icon">
          <i class="fas fa-seedling"></i>
        </div>
        <div class="info-card-content">
          <h3 class="info-card-title">Zakat Beras</h3>
          <ul class="info-card-list">
            <li>Kewajiban: 2.5 kg per jiwa</li>
            <li>Dapat dibayar dengan beras atau uang senilai</li>
            <li>Lebih mudah untuk distribusi</li>
          </ul>
        </div>
      </div>

      <div class="info-card info-card-blue">
        <div class="info-card-icon">
          <i class="fas fa-coins"></i>
        </div>
        <div class="info-card-content">
          <h3 class="info-card-title">Zakat Uang</h3>
          <ul class="info-card-list">
            <li>Kewajiban: Rp 45.000 per jiwa</li>
            <li>Lebih fleksibel untuk pengelolaan</li>
            <li>Mudah untuk perhitungan dan distribusi</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Modern Styles -->
  <style>
    /* Page Wrapper */
    .page-wrapper {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Page Header */
    .page-header {
      background: linear-gradient(135deg, #1EAF2F 0%, #16a127 50%, #0f8a1f 100%);
      border-radius: 20px;
      padding: 32px;
      box-shadow: 0 10px 30px rgba(30, 175, 47, 0.25);
      position: relative;
      overflow: hidden;
    }

    .page-header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
      border-radius: 50%;
      animation: pulse-animation 4s ease-in-out infinite;
    }

    @keyframes pulse-animation {

      0%,
      100% {
        transform: scale(1);
        opacity: 0.5;
      }

      50% {
        transform: scale(1.1);
        opacity: 0.8;
      }
    }

    .header-content-wrapper {
      position: relative;
      z-index: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .header-left-section {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .back-button {
      width: 44px;
      height: 44px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 18px;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .back-button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateX(-4px);
    }

    .header-icon-box {
      width: 60px;
      height: 60px;
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      color: white;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .header-text-box {
      color: white;
    }

    .header-title-text {
      font-size: 32px;
      font-weight: 700;
      margin: 0 0 6px 0;
      color: white;
    }

    .header-subtitle-text {
      font-size: 16px;
      margin: 0;
      color: rgba(255, 255, 255, 0.95);
    }

    .header-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .info-badge {
      background: rgba(255, 255, 255, 0.2);
      backdrop-filter: blur(10px);
      padding: 12px 20px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: white;
      font-weight: 600;
      font-size: 14px;
    }

    /* Form Container */
    .form-container {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* Form Card */
    .form-card {
      background: white;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }

    .card-header {
      background: linear-gradient(to right, #f9fafb, #f3f4f6);
      padding: 24px 28px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .card-header-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #1EAF2F 0%, #16a127 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
    }

    .card-header-text {
      flex: 1;
    }

    .card-title {
      font-size: 20px;
      font-weight: 700;
      color: #111827;
      margin: 0 0 4px 0;
    }

    .card-subtitle {
      font-size: 14px;
      color: #6b7280;
      margin: 0;
    }

    .card-body {
      padding: 28px;
    }

    /* Form Grid */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group-full {
      grid-column: span 2;
    }

    .form-group-double {
      grid-column: span 1;
    }

    .form-label {
      font-size: 14px;
      font-weight: 600;
      color: #374151;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .required {
      color: #ef4444;
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.2s ease;
      background: white;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #1EAF2F;
      box-shadow: 0 0 0 3px rgba(30, 175, 47, 0.1);
    }

    .input-readonly {
      background: #f3f4f6;
      cursor: not-allowed;
    }

    .form-hint {
      font-size: 12px;
      color: #6b7280;
      margin: 0;
    }

    /* Input with Prefix */
    .input-with-prefix {
      position: relative;
      display: flex;
      align-items: center;
    }

    .input-prefix {
      position: absolute;
      left: 16px;
      font-weight: 600;
      color: #6b7280;
      pointer-events: none;
      z-index: 1;
    }

    .input-with-prefix-field {
      padding-left: 48px;
    }

    /* Muzakki Section */
    .muzakki-section {
      padding: 20px;
      background: linear-gradient(to right, #f9fafb, #ffffff);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .muzakki-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .muzakki-section-title {
      font-size: 16px;
      font-weight: 600;
      color: #1EAF2F;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-remove-muzakki {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: #fee2e2;
      color: #991b1b;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-remove-muzakki:hover {
      background: #ef4444;
      color: white;
    }

    /* Button Add Muzakki */
    .btn-add-muzakki {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background: linear-gradient(135deg, #1EAF2F 0%, #16a127 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 16px;
    }

    .btn-add-muzakki:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(30, 175, 47, 0.3);
    }

    /* Kewajiban Box */
    .kewajiban-box {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px;
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      border: 2px solid #86efac;
      border-radius: 12px;
    }

    .kewajiban-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #1EAF2F 0%, #16a127 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
    }

    .kewajiban-content {
      flex: 1;
    }

    .kewajiban-label {
      font-size: 13px;
      color: #065f46;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .kewajiban-value {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
    }

    /* Form Actions */
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 24px 0;
    }

    .btn-primary,
    .btn-secondary {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 14px 28px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      text-decoration: none;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }

    .btn-primary {
      background: linear-gradient(135deg, #1EAF2F 0%, #16a127 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(30, 175, 47, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(30, 175, 47, 0.4);
    }

    .btn-secondary {
      background: white;
      color: #374151;
      border: 2px solid #e5e7eb;
    }

    .btn-secondary:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }

    /* Info Grid */
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .info-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid #e5e7eb;
      display: flex;
      gap: 16px;
    }

    .info-card-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      flex-shrink: 0;
    }

    .info-card-green .info-card-icon {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .info-card-blue .info-card-icon {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .info-card-content {
      flex: 1;
    }

    .info-card-title {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
      margin: 0 0 12px 0;
    }

    .info-card-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .info-card-list li {
      font-size: 14px;
      color: #6b7280;
      padding-left: 20px;
      position: relative;
    }

    .info-card-list li::before {
      content: 'â€¢';
      position: absolute;
      left: 0;
      color: #1EAF2F;
      font-weight: 700;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .form-grid {
        grid-template-columns: 1fr;
      }

      .form-group-full,
      .form-group-double {
        grid-column: span 1;
      }
    }

    @media (max-width: 768px) {
      .page-wrapper {
        padding: 16px;
      }

      .page-header {
        padding: 24px;
      }

      .header-content-wrapper {
        flex-direction: column;
        align-items: flex-start;
      }

      .header-title-text {
        font-size: 24px;
      }

      .card-body {
        padding: 20px;
      }

      .form-actions {
        flex-direction: column-reverse;
      }

      .btn-primary,
      .btn-secondary {
        width: 100%;
        justify-content: center;
      }
    }

    /* Utility Classes */
    border-radius: 12px;
    }

    .kewajiban-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, #1EAF2F 0%, #16a127 100%);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 20px;
    }

    .kewajiban-content {
      flex: 1;
    }

    .kewajiban-label {
      font-size: 13px;
      color: #065f46;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .kewajiban-value {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
    }

    /* Form Actions */
    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 24px 0;
    }

    .btn-primary,
    .btn-secondary {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 14px 28px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      text-decoration: none;
      transition: all 0.3s ease;
      border: none;
      cursor: pointer;
    }

    .btn-primary {
      background: linear-gradient(135deg, #1EAF2F 0%, #16a127 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(30, 175, 47, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(30, 175, 47, 0.4);
    }

    .btn-secondary {
      background: white;
      color: #374151;
      border: 2px solid #e5e7eb;
    }

    .btn-secondary:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }

    /* Info Grid */
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
    }

    .info-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      border: 1px solid #e5e7eb;
      display: flex;
      gap: 16px;
    }

    .info-card-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      flex-shrink: 0;
    }

    .info-card-green .info-card-icon {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    }

    .info-card-blue .info-card-icon {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    }

    .info-card-content {
      flex: 1;
    }

    .info-card-title {
      font-size: 18px;
      font-weight: 700;
      color: #111827;
      margin: 0 0 12px 0;
    }

    .info-card-list {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .info-card-list li {
      font-size: 14px;
      color: #6b7280;
      padding-left: 20px;
      position: relative;
    }

    .info-card-list li::before {
      content: 'â€¢';
      position: absolute;
      left: 0;
      color: #1EAF2F;
      font-weight: 700;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .form-grid {
        grid-template-columns: 1fr;
      }

      .form-group-full,
      .form-group-double {
        grid-column: span 1;
      }
    }

    @media (max-width: 768px) {
      .page-wrapper {
        padding: 16px;
      }

      .page-header {
        padding: 24px;
      }

      .header-content-wrapper {
        flex-direction: column;
        align-items: flex-start;
      }

      .header-title-text {
        font-size: 24px;
      }

      .card-body {
        padding: 20px;
      }

      .form-actions {
        flex-direction: column-reverse;
      }

      .btn-primary,
      .btn-secondary {
        width: 100%;
        justify-content: center;
      }
    }

    /* Utility Classes */
    .mr-1 {
      margin-right: 4px;
    }
  </style>

  <script>
    // Global variable untuk tracking jumlah muzakki
    let muzakkiCount = 1;

    // Function untuk menghitung dan mengupdate jumlah jiwa otomatis (REAL-TIME)
    function updateJumlahJiwa() {
      const muzakkiSections = document.querySelectorAll(".muzakki-section");
      // Hitung total section muzakki yang ada (tidak peduli isi nama)
      let totalJiwa = muzakkiSections.length;

      // Update field jumlah_jiwa
      const jumlahJiwaInput = document.getElementById("jumlah_jiwa");
      jumlahJiwaInput.value = totalJiwa;

      // Update visual indicator
      if (totalJiwa > 0) {
        jumlahJiwaInput.classList.remove("input-readonly");
        jumlahJiwaInput.classList.add("bg-green-50", "border-green-200");
      } else {
        jumlahJiwaInput.classList.add("input-readonly");
        jumlahJiwaInput.classList.remove("bg-green-50", "border-green-200");
      }

      // Trigger perhitungan zakat
      calculateZakat();

      // Debug log
      console.log(`Total muzakki sections: ${totalJiwa}`);
    }

    // Enhanced calculate zakat function
    function calculateZakat() {
      const jiwa = parseInt(document.getElementById("jumlah_jiwa").value) || 0;
      const jenisZakat = document.getElementById("jenis_zakat").value;
      const kewajibanDisplay = document.getElementById("kewajiban_display");

      if (jiwa > 0 && jenisZakat) {
        let kewajiban = 0;
        if (jenisZakat === "beras") {
          kewajiban = jiwa * 2.5; // 2.5 kg per jiwa
          kewajibanDisplay.textContent = kewajiban.toFixed(1) + " kg beras";
          kewajibanDisplay.style.color = "#059669";
        } else if (jenisZakat === "uang") {
          kewajiban = jiwa * 45000; // Rp 45.000 per jiwa
          kewajibanDisplay.textContent =
            "Rp " + kewajiban.toLocaleString("id-ID");
          kewajibanDisplay.style.color = "#2563eb";
        }
      } else {
        kewajibanDisplay.textContent = "-";
        kewajibanDisplay.style.color = "#9ca3af";
      }
    }

    // Function untuk menambah section muzakki baru
    function addMuzakkiSection() {
      const container = document.getElementById("muzakkiContainer");
      const newIndex = muzakkiCount;

      // HTML untuk section muzakki baru
      const newSection = `
      <div class="muzakki-section" data-index="${newIndex}">
        <div class="muzakki-section-header">
          <h4 class="muzakki-section-title">
            <i class="fas fa-user-circle"></i>Muzakki #${newIndex + 1}
          </h4>
          <button
            type="button"
            class="btn-remove-muzakki"
            onclick="removeMuzakkiSection(${newIndex})"
          >
            <i class="fas fa-trash"></i>Hapus
          </button>
        </div>
        
        <div class="form-grid">
          <!-- Nama Muzakki -->
          <div class="form-group form-group-full">
            <label
              for="nama_${newIndex}"
              class="form-label"
            >
              <i class="fas fa-user mr-1"></i>Nama Lengkap Muzakki <span class="required">*</span>
            </label>
            <input
              type="text"
              id="nama_${newIndex}"
              name="muzakki[${newIndex}][nama]"
              required
              class="form-input"
              placeholder="Masukkan nama lengkap muzakki"
            />
          </div>

          <!-- Bin/Binti -->
          <div class="form-group">
            <label
              for="bin_binti_${newIndex}"
              class="form-label"
            >
              <i class="fas fa-venus-mars mr-1"></i>Bin/Binti
            </label>
            <select
              id="bin_binti_${newIndex}"
              name="muzakki[${newIndex}][bin_binti]"
              class="form-select"
            >
              <option value="">Pilih</option>
              <option value="bin">Bin (Anak Laki-laki)</option>
              <option value="binti">Binti (Anak Perempuan)</option>
            </select>
            <p class="form-hint">
              Bin untuk laki-laki, Binti untuk perempuan
            </p>
          </div>

          <!-- Nama Orang Tua -->
          <div class="form-group form-group-double">
            <label
              for="nama_orang_tua_${newIndex}"
              class="form-label"
            >
              <i class="fas fa-users mr-1"></i>Nama Orang Tua
            </label>
            <input
              type="text"
              id="nama_orang_tua_${newIndex}"
              name="muzakki[${newIndex}][nama_orang_tua]"
              class="form-input"
              placeholder="Masukkan nama ayah atau ibu sesuai bin/binti"
            />
            <p class="form-hint">
              Nama ayah jika "bin", nama ibu jika "binti"
            </p>
          </div>
        </div>
      </div>
    `;

      // Tambahkan section baru ke container
      container.insertAdjacentHTML("beforeend", newSection);

      // Update counter
      muzakkiCount++;

      // Update visibility tombol tambah (maksimal 5 muzakki)
      updateAddButtonVisibility();

      // Update jumlah jiwa LANGSUNG setelah menambah section
      updateJumlahJiwa();

      // Scroll ke section yang baru ditambahkan
      const newSectionElement = container.lastElementChild;
      newSectionElement.scrollIntoView({ behavior: "smooth", block: "center" });
    }

    // Function untuk menghapus section muzakki dengan SweetAlert2
    function removeMuzakkiSection(index) {
      // Cek apakah SweetAlert2 tersedia
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          title: 'Hapus Muzakki?',
          text: 'Apakah Anda yakin ingin menghapus data muzakki ini?',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#ef4444',
          cancelButtonColor: '#6b7280',
          confirmButtonText: 'Ya, Hapus',
          cancelButtonText: 'Batal',
          reverseButtons: true
        }).then((result) => {
          if (result.isConfirmed) {
            const section = document.querySelector(`[data-index="${index}"]`);
            if (section) {
              section.remove();
              muzakkiCount--;
              updateAddButtonVisibility();
              updateMuzakkiNumbers();
              updateJumlahJiwa(); // Update jumlah jiwa setelah hapus

              // Tampilkan notifikasi sukses
              Swal.fire({
                title: 'Terhapus!',
                text: 'Data muzakki berhasil dihapus.',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
              });
            }
          }
        });
      } else {
        // Fallback ke confirm default jika SweetAlert2 tidak tersedia
        if (confirm("Apakah Anda yakin ingin menghapus data muzakki ini?")) {
          const section = document.querySelector(`[data-index="${index}"]`);
          if (section) {
            section.remove();
            muzakkiCount--;
            updateAddButtonVisibility();
            updateMuzakkiNumbers();
            updateJumlahJiwa();
          }
        }
      }
    }

    // Function untuk update nomor muzakki setelah penghapusan
    function updateMuzakkiNumbers() {
      const sections = document.querySelectorAll(".muzakki-section");
      sections.forEach((section, index) => {
        const title = section.querySelector(".muzakki-section-title");
        if (title) {
          title.innerHTML = `<i class="fas fa-user-circle"></i>Muzakki #${index + 1
            }`;
        }
      });
    }

    // Function untuk mengatur visibility tombol tambah
    function updateAddButtonVisibility() {
      const addBtn = document.getElementById("addMuzakkiBtn");
      const sections = document.querySelectorAll(".muzakki-section");

      if (sections.length >= 5) {
        addBtn.style.display = "none";
      } else {
        addBtn.style.display = "inline-flex";
      }
    }

    // Rupiah formatting functions
    function formatToRupiah(number) {
      if (!number || number === 0) return "0";
      return new Intl.NumberFormat("id-ID").format(number);
    }

    function parseFromRupiah(rupiahString) {
      if (!rupiahString) return 0;
      // Remove all non-numeric characters
      const cleanNumber = rupiahString.replace(/[^\d]/g, "");
      return parseInt(cleanNumber) || 0;
    }

    // Handle rupiah input in real-time
    function handleRupiahInput(input) {
      // Get current cursor position
      const cursorPosition = input.selectionStart;
      const oldValue = input.value;

      // Extract numbers only
      const numericValue = input.value.replace(/[^\d]/g, "");
      const numberValue = parseInt(numericValue) || 0;

      // Format to rupiah
      const formattedValue = formatToRupiah(numberValue);

      // Update display input
      input.value = formattedValue;

      // Update hidden input
      document.getElementById("jumlah_bayar").value = numberValue;

      // Restore cursor position (approximate)
      const newLength = formattedValue.length;
      const oldLength = oldValue.length;
      const newCursorPosition = cursorPosition + (newLength - oldLength);

      setTimeout(() => {
        input.setSelectionRange(newCursorPosition, newCursorPosition);
      }, 0);
    }

    // Prepare input when focused
    function prepareRupiahInput(input) {
      const hiddenValue = document.getElementById("jumlah_bayar").value;
      if (hiddenValue && hiddenValue !== "0") {
        // Show raw number for easier editing
        input.value = hiddenValue;
        // Select all for easy replacement
        setTimeout(() => input.select(), 50);
      }
    }

    // Finalize input when focus is lost
    function finalizeRupiahInput(input) {
      const numericValue = parseFromRupiah(input.value);
      const formattedValue = formatToRupiah(numericValue);

      // Update both inputs
      input.value = formattedValue;
      document.getElementById("jumlah_bayar").value = numericValue;
    }

    // Add event listeners when document is ready
    document.addEventListener("DOMContentLoaded", function () {
      const displayInput = document.getElementById("jumlah_bayar_display");

      // Prevent non-numeric input
      displayInput.addEventListener("keypress", function (e) {
        // Allow: backspace, delete, tab, escape, enter, and numbers
        if (
          !/[\d]/.test(e.key) &&
          ![
            "Backspace",
            "Delete",
            "Tab",
            "ArrowLeft",
            "ArrowRight",
            "Enter",
          ].includes(e.key)
        ) {
          e.preventDefault();
        }
      });

      // Handle paste events
      displayInput.addEventListener("paste", function (e) {
        e.preventDefault();
        const pastedText = (e.clipboardData || window.clipboardData).getData(
          "text"
        );
        const numericValue = pastedText.replace(/[^\d]/g, "");
        if (numericValue) {
          this.value = numericValue;
          handleRupiahInput(this);
        }
      });

      // Initialize jumlah jiwa dengan menghitung muzakki yang ada
      updateJumlahJiwa();
    });

    // Form validation
    document
      .getElementById("muzakkiForm")
      .addEventListener("submit", function (e) {
        const jiwa = parseInt(document.getElementById("jumlah_jiwa").value);
        const jenisZakat = document.getElementById("jenis_zakat").value;
        const jumlahBayar = parseInt(
          document.getElementById("jumlah_bayar").value
        );

        // Validasi basic fields
        if (jiwa <= 0) {
          e.preventDefault();
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'error',
              title: 'Validasi Gagal',
              text: 'Jumlah jiwa harus lebih dari 0. Tambahkan minimal 1 muzakki.',
              confirmButtonColor: '#1EAF2F'
            });
          } else {
            alert("Jumlah jiwa harus lebih dari 0");
          }
          return false;
        }

        if (!jenisZakat) {
          e.preventDefault();
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'error',
              title: 'Validasi Gagal',
              text: 'Pilih jenis zakat terlebih dahulu',
              confirmButtonColor: '#1EAF2F'
            });
          } else {
            alert("Pilih jenis zakat terlebih dahulu");
          }
          return false;
        }

        if (jumlahBayar <= 0 || isNaN(jumlahBayar)) {
          e.preventDefault();
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'error',
              title: 'Validasi Gagal',
              text: 'Jumlah bayar harus lebih dari 0',
              confirmButtonColor: '#1EAF2F'
            });
          } else {
            alert("Jumlah bayar harus lebih dari 0");
          }
          return false;
        }

        // Validasi semua section muzakki
        const muzakkiSections = document.querySelectorAll(".muzakki-section");
        let hasEmptyName = false;
        let emptyNameIndex = -1;

        muzakkiSections.forEach((section, index) => {
          const namaInput = section.querySelector(
            `input[name^="muzakki"][name$="[nama]"]`
          );
          if (!namaInput.value.trim()) {
            hasEmptyName = true;
            emptyNameIndex = index + 1;
          }
        });

        if (hasEmptyName) {
          e.preventDefault();
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'error',
              title: 'Validasi Gagal',
              text: `Nama muzakki #${emptyNameIndex} tidak boleh kosong`,
              confirmButtonColor: '#1EAF2F'
            });
          } else {
            alert(`Nama muzakki #${emptyNameIndex} tidak boleh kosong`);
          }
          return false;
        }

        // Konfirmasi final dengan SweetAlert2
        e.preventDefault();
        const muzakkiCount = muzakkiSections.length;

        if (typeof Swal !== 'undefined') {
          Swal.fire({
            title: 'Konfirmasi Data',
            html: `
            <div style="text-align: left; padding: 10px;">
              <p style="margin-bottom: 8px;"><strong>Apakah data yang dimasukkan sudah benar?</strong></p>
              <ul style="list-style: none; padding-left: 0;">
                <li style="margin-bottom: 6px;">ðŸ“Š Jumlah Muzakki: <strong>${muzakkiCount} orang</strong></li>
                <li style="margin-bottom: 6px;">ðŸ‘¥ Jumlah Jiwa: <strong>${jiwa} jiwa</strong></li>
                <li style="margin-bottom: 6px;">ðŸŽ¯ Jenis Zakat: <strong>${jenisZakat}</strong></li>
                <li style="margin-bottom: 6px;">ðŸ’° Jumlah Bayar: <strong>Rp ${jumlahBayar.toLocaleString("id-ID")}</strong></li>
              </ul>
            </div>
          `,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#1EAF2F',
            cancelButtonColor: '#6b7280',
            confirmButtonText: 'Ya, Simpan',
            cancelButtonText: 'Periksa Lagi',
            reverseButtons: true
          }).then((result) => {
            if (result.isConfirmed) {
              // Submit form
              document.getElementById("muzakkiForm").submit();
            }
          });
        } else {
          // Fallback ke confirm default
          const confirmMessage =
            `Apakah data yang dimasukkan sudah benar?\n\n` +
            `- Jumlah Muzakki: ${muzakkiCount} orang\n` +
            `- Jumlah Jiwa: ${jiwa} jiwa\n` +
            `- Jenis Zakat: ${jenisZakat}\n` +
            `- Jumlah Bayar: Rp ${jumlahBayar.toLocaleString("id-ID")}`;

          if (confirm(confirmMessage)) {
            document.getElementById("muzakkiForm").submit();
          }
        }

        return false;
      });
  </script>

  <%- include('../layouts/footer') %>