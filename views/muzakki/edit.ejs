<%- include('../layouts/header', { title: 'Edit Muzakki - Zakat Fitrah App', bodyClass: 'bg-gray-50 min-h-screen', currentPage: 'muzakki' }) %>

<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-6">
        <div class="flex items-center mb-4">
            <a href="/muzakki" class="text-primary-600 hover:text-primary-800 mr-4">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1 class="text-3xl font-bold text-gray-900">
                <i class="fas fa-edit mr-2 text-primary-600"></i>Edit Muzakki
            </h1>
        </div>
        <p class="text-gray-600">Edit data muzakki: <strong><%= muzakki.nama %></strong></p>
    </div>

    <!-- Form -->
    <div class="card">
        <form action="/muzakki/<%= muzakki.id %>?_method=PUT" method="POST" id="muzakkiForm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- RT Selection -->
                <div>
                    <label for="rt_id" class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-map-marker-alt mr-1 text-gray-500"></i>RT *
                    </label>
                    <select id="rt_id" name="rt_id" required class="form-select mt-1">
                        <option value="">Pilih RT</option>
                        <% rtList.forEach(function(rt) { %>
                        <option value="<%= rt.id %>" <%= rt.id === muzakki.rt_id ? 'selected' : '' %>>
                            <%= rt.nomor_rt %> - <%= rt.ketua_rt %>
                        </option>
                        <% }); %>
                    </select>
                </div>

                <!-- Nama Muzakki -->
                <div>
                    <label for="nama" class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-user mr-1 text-gray-500"></i>Nama Muzakki *
                    </label>
                    <input type="text" id="nama" name="nama" required 
                           class="form-input mt-1" 
                           value="<%= muzakki.nama %>"
                           placeholder="Masukkan nama lengkap muzakki">
                </div>

                <!-- Jumlah Jiwa -->
                <div>
                    <label for="jumlah_jiwa" class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-users mr-1 text-gray-500"></i>Jumlah Jiwa *
                    </label>
                    <input type="number" id="jumlah_jiwa" name="jumlah_jiwa" required min="1" 
                           class="form-input mt-1" 
                           value="<%= muzakki.jumlah_jiwa %>"
                           placeholder="Jumlah jiwa yang ditanggung"
                           onchange="calculateZakat()">
                    <p class="text-xs text-gray-500 mt-1">Jumlah jiwa yang ditanggung zakatnya</p>
                </div>

                <!-- Jenis Zakat -->
                <div>
                    <label for="jenis_zakat" class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-hand-holding mr-1 text-gray-500"></i>Jenis Zakat *
                    </label>
                    <select id="jenis_zakat" name="jenis_zakat" required class="form-select mt-1" onchange="calculateZakat()">
                        <option value="">Pilih jenis zakat</option>
                        <option value="beras" <%= muzakki.jenis_zakat === 'beras' ? 'selected' : '' %>>
                            Beras (2.5 kg/jiwa)
                        </option>
                        <option value="uang" <%= muzakki.jenis_zakat === 'uang' ? 'selected' : '' %>>
                            Uang (Rp 45.000/jiwa)
                        </option>
                    </select>
                </div>

                <!-- Kewajiban Display -->
                <div class="md:col-span-2">
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="text-sm font-medium text-gray-700">Kewajiban Zakat</h4>
                                <p class="text-lg font-bold text-primary-600" id="kewajiban_display">
                                    <% if (muzakki.jenis_zakat === 'beras') { %>
                                        <%= muzakki.jumlah_beras_kg %> kg beras
                                    <% } else { %>
                                        Rp <%= muzakki.jumlah_uang.toLocaleString('id-ID') %>
                                    <% } %>
                                </p>
                            </div>
                            <i class="fas fa-calculator text-2xl text-gray-300"></i>
                        </div>
                    </div>
                </div>

                <!-- Jumlah Bayar -->
                <div class="md:col-span-2">
                    <label for="jumlah_bayar" class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-money-bill-wave mr-1 text-gray-500"></i>Jumlah Bayar (Rp) *
                    </label>
                    <input type="number" id="jumlah_bayar" name="jumlah_bayar" required min="0" step="0.01"
                           class="form-input mt-1" 
                           value="<%= muzakki.jumlah_bayar %>"
                           placeholder="Masukkan jumlah yang dibayarkan dalam rupiah">
                    <p class="text-xs text-gray-500 mt-1">
                        Jika lebih dari kewajiban, selisihnya akan menjadi kembalian yang bisa disedekahkan
                    </p>
                    <% if (muzakki.kembalian > 0) { %>
                    <div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded">
                        <p class="text-sm text-yellow-800">
                            <i class="fas fa-info-circle mr-1"></i>
                            Kembalian saat ini: <strong>Rp <%= muzakki.kembalian.toLocaleString('id-ID') %></strong>
                        </p>
                    </div>
                    <% } %>
                </div>

                <!-- Catatan -->
                <div class="md:col-span-2">
                    <label for="catatan" class="block text-sm font-medium text-gray-700">
                        <i class="fas fa-sticky-note mr-1 text-gray-500"></i>Catatan (Opsional)
                    </label>
                    <textarea id="catatan" name="catatan" rows="3" 
                              class="form-input mt-1" 
                              placeholder="Catatan tambahan atau keterangan khusus"><%= muzakki.catatan || '' %></textarea>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="mt-8 flex justify-end space-x-4">
                <a href="/muzakki" class="btn-secondary">
                    <i class="fas fa-times mr-2"></i>Batal
                </a>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-save mr-2"></i>Update Data
                </button>
            </div>
        </form>
    </div>

    <!-- Data History -->
    <div class="mt-6 card">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-history mr-2 text-gray-600"></i>Informasi Data
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
            <div>
                <span class="text-gray-600">Dibuat:</span>
                <div class="font-medium"><%= new Date(muzakki.created_at).toLocaleString('id-ID') %></div>
            </div>
            <div>
                <span class="text-gray-600">Diupdate:</span>
                <div class="font-medium"><%= new Date(muzakki.updated_at).toLocaleString('id-ID') %></div>
            </div>
            <div>
                <span class="text-gray-600">Pencatat:</span>
                <div class="font-medium">ID: <%= muzakki.user_id %></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Calculate zakat on page load
    document.addEventListener('DOMContentLoaded', function() {
        calculateZakat();
    });

    // Enhanced calculate zakat function
    function calculateZakat() {
        const jiwa = parseInt(document.getElementById('jumlah_jiwa').value) || 0;
        const jenisZakat = document.getElementById('jenis_zakat').value;
        const kewajibanDisplay = document.getElementById('kewajiban_display');
        
        if (jiwa > 0 && jenisZakat) {
            let kewajiban = 0;
            if (jenisZakat === 'beras') {
                kewajiban = jiwa * 2.5; // 2.5 kg per jiwa
                kewajibanDisplay.textContent = kewajiban.toFixed(1) + ' kg beras';
                kewajibanDisplay.className = 'text-lg font-bold text-green-600';
            } else if (jenisZakat === 'uang') {
                kewajiban = jiwa * 45000; // Rp 45.000 per jiwa
                kewajibanDisplay.textContent = 'Rp ' + kewajiban.toLocaleString('id-ID');
                kewajibanDisplay.className = 'text-lg font-bold text-blue-600';
            }
        } else {
            kewajibanDisplay.textContent = '-';
            kewajibanDisplay.className = 'text-lg font-bold text-gray-400';
        }
    }

    // Form validation
    document.getElementById('muzakkiForm').addEventListener('submit', function(e) {
        const jiwa = parseInt(document.getElementById('jumlah_jiwa').value);
        const jenisZakat = document.getElementById('jenis_zakat').value;
        const jumlahBayar = parseFloat(document.getElementById('jumlah_bayar').value);

        if (jiwa <= 0) {
            e.preventDefault();
            alert('Jumlah jiwa harus lebih dari 0');
            return false;
        }

        if (!jenisZakat) {
            e.preventDefault();
            alert('Pilih jenis zakat terlebih dahulu');
            return false;
        }

        if (jumlahBayar <= 0) {
            e.preventDefault();
            alert('Jumlah bayar harus lebih dari 0');
            return false;
        }

        return confirm('Apakah perubahan data sudah benar?');
    });
</script>

<%- include('../layouts/footer') %>