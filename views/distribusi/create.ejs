<%- include('../layouts/header', { title: title, bodyClass: 'bg-gray-50 min-h-screen', currentPage: 'distribusi' }) %>

<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
  <!-- Header -->
  <div class="mb-8">
    <div class="flex items-center">
      <a href="/distribusi" class="text-gray-500 hover:text-gray-700 mr-4">
        <i class="fas fa-arrow-left text-lg"></i>
      </a>
      <div>
        <h1 class="text-3xl font-bold text-gray-900">
          <i class="fas fa-plus-circle mr-2 text-primary-600"></i>Distribusi Baru
        </h1>
        <p class="text-gray-600 mt-1">Buat distribusi zakat kepada mustahik</p>
      </div>
    </div>
  </div>

  <!-- Form -->
  <div class="bg-white shadow-sm rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900">
        <i class="fas fa-form mr-2 text-primary-600"></i>Form Distribusi Zakat
      </h2>
    </div>

    <form method="POST" action="/distribusi/create" class="p-6 space-y-6" id="distributionForm">
      <!-- Mustahik Selection -->
      <div>
        <label for="mustahik_id" class="block text-sm font-medium text-gray-700 mb-2">
          Pilih Mustahik <span class="text-red-500">*</span>
        </label>
        <select id="mustahik_id" name="mustahik_id" required
                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm
                       focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
          <option value="">-- Pilih Mustahik --</option>
          <% mustahiks.forEach(m => { %>
          <option value="<%= m.id %>" <%= selectedMustahik == m.id ? 'selected' : '' %>
                  data-kategori="<%= m.kategori %>" data-rt="<%= m.rt_nama || 'Tidak terdaftar' %>">
            <%= m.nama %> - <%= m.kategori.charAt(0).toUpperCase() + m.kategori.slice(1) %>
            <% if (m.rt_nama) { %>(RT <%= m.rt_nama %>)<% } %>
          </option>
          <% }); %>
        </select>
        <p class="mt-1 text-sm text-gray-500" id="mustahikInfo">
          Pilih mustahik yang akan menerima distribusi zakat
        </p>
      </div>

      <!-- Jenis Zakat -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Jenis Zakat <span class="text-red-500">*</span>
        </label>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="relative">
            <input type="radio" id="jenis_beras" name="jenis_zakat" value="beras" required
                   class="sr-only peer">
            <label for="jenis_beras" 
                   class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer
                          hover:bg-gray-50 peer-checked:border-primary-500 peer-checked:bg-primary-50">
              <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-green-500 rounded-lg flex items-center justify-center">
                  <i class="fas fa-seedling text-white"></i>
                </div>
              </div>
              <div class="ml-4">
                <div class="text-sm font-medium text-gray-900">Beras</div>
                <div class="text-sm text-gray-500">Distribusi dalam bentuk beras (kg)</div>
              </div>
            </label>
          </div>

          <div class="relative">
            <input type="radio" id="jenis_uang" name="jenis_zakat" value="uang" required
                   class="sr-only peer">
            <label for="jenis_uang" 
                   class="flex items-center p-4 border-2 border-gray-200 rounded-lg cursor-pointer
                          hover:bg-gray-50 peer-checked:border-primary-500 peer-checked:bg-primary-50">
              <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-yellow-500 rounded-lg flex items-center justify-center">
                  <i class="fas fa-coins text-white"></i>
                </div>
              </div>
              <div class="ml-4">
                <div class="text-sm font-medium text-gray-900">Uang</div>
                <div class="text-sm text-gray-500">Distribusi dalam bentuk uang (Rp)</div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- Jumlah -->
      <div>
        <label for="jumlah" class="block text-sm font-medium text-gray-700 mb-2">
          Jumlah <span class="text-red-500">*</span>
        </label>
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center">
            <span class="text-gray-500 text-sm" id="jumlahPrefix">-</span>
          </div>
          <input type="number" id="jumlah" name="jumlah" required min="0.1" step="0.1"
                 placeholder="Masukkan jumlah"
                 class="block w-full pl-12 pr-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm
                        focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
          <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
            <span class="text-gray-500 text-sm" id="jumlahSuffix">-</span>
          </div>
        </div>
        <p class="mt-1 text-sm text-gray-500" id="jumlahHelp">
          Pilih jenis zakat terlebih dahulu untuk melihat format input
        </p>
      </div>

      <!-- Tanggal Distribusi -->
      <div>
        <label for="tanggal_distribusi" class="block text-sm font-medium text-gray-700 mb-2">
          Tanggal Distribusi <span class="text-red-500">*</span>
        </label>
        <input type="date" id="tanggal_distribusi" name="tanggal_distribusi" required
               value="<%= new Date().toISOString().split('T')[0] %>"
               class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm
                      focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
        <p class="mt-1 text-sm text-gray-500">
          Tanggal ketika distribusi akan atau telah dilakukan
        </p>
      </div>

      <!-- Status -->
      <div>
        <label for="status" class="block text-sm font-medium text-gray-700 mb-2">
          Status <span class="text-red-500">*</span>
        </label>
        <select id="status" name="status" required
                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm
                       focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500">
          <option value="pending">Pending - Menunggu distribusi</option>
          <option value="disalurkan">Disalurkan - Sudah disalurkan kepada mustahik</option>
          <option value="diterima">Diterima - Sudah diterima oleh mustahik</option>
        </select>
        <p class="mt-1 text-sm text-gray-500">
          Status saat ini dari distribusi zakat
        </p>
      </div>

      <!-- Keterangan -->
      <div>
        <label for="keterangan" class="block text-sm font-medium text-gray-700 mb-2">
          Keterangan
        </label>
        <textarea id="keterangan" name="keterangan" rows="3"
                  placeholder="Catatan tambahan tentang distribusi (opsional)"
                  class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm
                         focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"></textarea>
        <p class="mt-1 text-sm text-gray-500">
          Informasi tambahan atau catatan khusus tentang distribusi ini
        </p>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
        <a href="/distribusi" class="btn-secondary">
          <i class="fas fa-times mr-2"></i>Batal
        </a>
        <button type="submit" class="btn-primary">
          <i class="fas fa-save mr-2"></i>Simpan Distribusi
        </button>
      </div>
    </form>
  </div>

  <!-- Check Available Stock (if any) -->
  <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
    <div class="flex">
      <div class="flex-shrink-0">
        <i class="fas fa-info-circle text-blue-400"></i>
      </div>
      <div class="ml-3">
        <h3 class="text-sm font-medium text-blue-800">Informasi Stok</h3>
        <div class="mt-2 text-sm text-blue-700">
          <p>Pastikan stok zakat mencukupi sebelum membuat distribusi.</p>
          <div class="mt-2" id="stockInfo">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <div class="bg-white rounded-lg p-3 border border-blue-100">
                <div class="text-xs text-gray-500 mb-1">Stok Beras</div>
                <div class="font-medium text-green-600">
                  <i class="fas fa-seedling mr-1"></i>
                  <%= stockInfo.beras.toLocaleString('id-ID') %> kg
                </div>
              </div>
              <div class="bg-white rounded-lg p-3 border border-blue-100">
                <div class="text-xs text-gray-500 mb-1">Stok Uang</div>
                <div class="font-medium text-yellow-600">
                  <i class="fas fa-coins mr-1"></i>
                  Rp <%= stockInfo.uang.toLocaleString('id-ID') %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const mustahikSelect = document.getElementById('mustahik_id');
  const mustahikInfo = document.getElementById('mustahikInfo');
  const jenisRadios = document.querySelectorAll('input[name="jenis_zakat"]');
  const jumlahInput = document.getElementById('jumlah');
  const jumlahPrefix = document.getElementById('jumlahPrefix');
  const jumlahSuffix = document.getElementById('jumlahSuffix');
  const jumlahHelp = document.getElementById('jumlahHelp');

  // Update mustahik info
  mustahikSelect.addEventListener('change', function() {
    const selectedOption = this.options[this.selectedIndex];
    if (selectedOption.value) {
      const kategori = selectedOption.dataset.kategori;
      const rt = selectedOption.dataset.rt;
      mustahikInfo.innerHTML = `
        <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 mr-2">
          ${kategori.charAt(0).toUpperCase() + kategori.slice(1)}
        </span>
        <span class="text-gray-500">${rt}</span>
      `;
    } else {
      mustahikInfo.textContent = 'Pilih mustahik yang akan menerima distribusi zakat';
    }
  });

  // Update jumlah input based on jenis zakat
  jenisRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      if (this.value === 'beras') {
        jumlahPrefix.textContent = '';
        jumlahSuffix.textContent = 'kg';
        jumlahInput.placeholder = 'Contoh: 2.5';
        jumlahHelp.innerHTML = `
          <i class="fas fa-seedling text-green-600 mr-1"></i>
          Masukkan jumlah beras dalam kilogram (kg)
        `;
        jumlahInput.step = '0.1';
        jumlahInput.min = '0.1';
      } else if (this.value === 'uang') {
        jumlahPrefix.textContent = 'Rp';
        jumlahSuffix.textContent = '';
        jumlahInput.placeholder = 'Contoh: 50000';
        jumlahHelp.innerHTML = `
          <i class="fas fa-coins text-yellow-600 mr-1"></i>
          Masukkan jumlah uang dalam rupiah (Rp)
        `;
        jumlahInput.step = '1000';
        jumlahInput.min = '1000';
      }
      jumlahInput.value = '';
    });
  });

  // Format number input for currency
  jumlahInput.addEventListener('input', function() {
    const jenisZakat = document.querySelector('input[name="jenis_zakat"]:checked');
    if (jenisZakat && jenisZakat.value === 'uang') {
      // Remove non-numeric characters except decimal point
      let value = this.value.replace(/[^\d]/g, '');
      if (value) {
        // Format as currency without decimal for whole numbers
        this.value = parseInt(value);
      }
    }
  });

  // Form validation
  document.getElementById('distributionForm').addEventListener('submit', function(e) {
    const mustahikId = document.getElementById('mustahik_id').value;
    const jenisZakat = document.querySelector('input[name="jenis_zakat"]:checked');
    const jumlah = document.getElementById('jumlah').value;
    const tanggalDistribusi = document.getElementById('tanggal_distribusi').value;
    const status = document.getElementById('status').value;

    if (!mustahikId) {
      alert('Silakan pilih mustahik terlebih dahulu');
      e.preventDefault();
      return;
    }

    if (!jenisZakat) {
      alert('Silakan pilih jenis zakat terlebih dahulu');
      e.preventDefault();
      return;
    }

    if (!jumlah || parseFloat(jumlah) <= 0) {
      alert('Jumlah harus lebih dari 0');
      e.preventDefault();
      return;
    }

    if (jenisZakat.value === 'uang' && parseFloat(jumlah) < 1000) {
      alert('Jumlah uang minimal Rp 1.000');
      e.preventDefault();
      return;
    }

    if (jenisZakat.value === 'beras' && parseFloat(jumlah) < 0.1) {
      alert('Jumlah beras minimal 0.1 kg');
      e.preventDefault();
      return;
    }

    if (!tanggalDistribusi) {
      alert('Silakan pilih tanggal distribusi');
      e.preventDefault();
      return;
    }

    if (!status) {
      alert('Silakan pilih status distribusi');
      e.preventDefault();
      return;
    }

    // Check if selected date is not in the future for completed status
    const selectedDate = new Date(tanggalDistribusi);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (status === 'diterima' && selectedDate > today) {
      if (!confirm('Tanggal distribusi di masa depan namun status sudah diterima. Lanjutkan?')) {
        e.preventDefault();
        return;
      }
    }
  });

  // Auto-fill mustahik if provided in URL
  const urlParams = new URLSearchParams(window.location.search);
  const mustahikIdParam = urlParams.get('mustahik_id');
  if (mustahikIdParam) {
    mustahikSelect.value = mustahikIdParam;
    mustahikSelect.dispatchEvent(new Event('change'));
  }
});
</script>

<%- include('../layouts/footer') %>